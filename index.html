<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FreeSearch</title>
  <style>
    /* Base Reset */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #121212;
      color: #e0e0e0;
      display: flex;
      height: 100vh;
      overflow: hidden;
      user-select: none;
    }
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #1e1e1e;
    }
    ::-webkit-scrollbar-thumb {
      background-color: #555;
      border-radius: 4px;
    }
    /* Sidebar */
    #sidebar {
      background: #1f1f1f;
      width: 280px;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      padding: 15px 10px;
      border-right: 1px solid #333;
      transition: width 0.3s ease;
    }
    #sidebar.collapsed {
      width: 60px;
      min-width: 60px;
    }
    #sidebar header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    #sidebar header h1 {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 0;
      user-select: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #64b5f6;
    }
    #toggleSidebarBtn {
      background: transparent;
      border: none;
      color: #64b5f6;
      font-size: 1.5rem;
      cursor: pointer;
      transition: transform 0.3s ease;
      user-select: none;
    }
    #sidebar.collapsed #toggleSidebarBtn {
      transform: rotate(180deg);
    }
    /* Chat list */
    #chatList {
      flex: 1;
      overflow-y: auto;
      padding-right: 5px;
    }
    .chatItem {
      background: #2c2c2c;
      margin: 5px 0;
      padding: 10px 12px;
      border-radius: 9999px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background-color 0.2s ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chatItem.active {
      background: #64b5f6;
      color: #121212;
      font-weight: bold;
    }
    .chatTitle {
      flex: 1;
      margin-right: 8px;
      user-select: text;
    }
    .chatMenuBtn {
      background: transparent;
      border: none;
      color: inherit;
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0 4px;
      user-select: none;
      position: relative;
    }
    .chatMenu {
      position: absolute;
      top: 28px;
      right: 6px;
      background: #333;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.6);
      min-width: 120px;
      z-index: 20;
      display: none;
      flex-direction: column;
      user-select: none;
    }
    .chatMenu.show {
      display: flex;
    }
    .chatMenu button {
      background: transparent;
      border: none;
      color: #e0e0e0;
      padding: 8px 12px;
      text-align: left;
      width: 100%;
      cursor: pointer;
      font-size: 0.9rem;
      border-radius: 0;
      transition: background-color 0.2s ease;
    }
    .chatMenu button:hover {
      background-color: #64b5f6;
      color: #121212;
    }
    /* Sidebar Buttons */
    #sidebarButtons {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
    #sidebarButtons button {
      background: #64b5f6;
      border: none;
      color: #121212;
      padding: 8px 15px;
      font-weight: 700;
      border-radius: 9999px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
      font-size: 0.95rem;
    }
    #sidebarButtons button:hover {
      background: #4a8cd8;
    }
    /* Chat area */
    #chatArea {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #181818;
    }
    #chatMessages {
      flex: 1;
      padding: 20px 25px;
      overflow-y: auto;
      scroll-behavior: smooth;
      user-select: text;
    }
    .msg {
      max-width: 75%;
      margin: 10px 0;
      padding: 12px 18px;
      border-radius: 20px;
      line-height: 1.5em;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 1rem;
    }
    .user {
      background: #2c2c2c;
      color: #90caf9;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    .bot {
      background: #333;
      color: #e0e0e0;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }
    /* Input area */
    #inputArea {
      display: flex;
      padding: 15px 25px;
      background: #121212;
      border-top: 1px solid #333;
      user-select: none;
    }
    #inputArea input[type="text"] {
      flex: 1;
      padding: 12px 15px;
      border-radius: 9999px;
      border: none;
      background: #2a2a2a;
      color: #e0e0e0;
      font-size: 1rem;
      outline-offset: 2px;
      user-select: text;
      transition: background-color 0.2s ease;
    }
    #inputArea input[type="text"]:focus {
      background: #3a3a3a;
    }
    #inputArea button {
      background: #64b5f6;
      border: none;
      color: #121212;
      font-weight: 700;
      padding: 12px 25px;
      margin-left: 15px;
      border-radius: 9999px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
      font-size: 1rem;
    }
    #inputArea button:hover {
      background: #4a8cd8;
    }
    /* Settings Modal */
    #settingsModal {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      user-select: none;
    }
    #settingsModal.show {
      display: flex;
    }
    #settingsContent {
      background: #1f1f1f;
      padding: 25px 30px;
      border-radius: 15px;
      width: 320px;
      max-width: 90vw;
      color: #e0e0e0;
      box-shadow: 0 0 20px rgba(100, 181, 246, 0.6);
    }
    #settingsContent h2 {
      margin-top: 0;
      font-weight: 700;
      font-size: 1.4rem;
      margin-bottom: 20px;
      color: #64b5f6;
      user-select: text;
    }
    #settingsContent label {
      display: block;
      margin-bottom: 10px;
      user-select: none;
      font-weight: 600;
    }
    #settingsContent input[type="checkbox"] {
      margin-right: 10px;
      vertical-align: middle;
      cursor: pointer;
    }
    #settingsContent button {
      margin-top: 20px;
      width: 100%;
      background: #64b5f6;
      border: none;
      color: #121212;
      font-weight: 700;
      padding: 12px;
      border-radius: 9999px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
      font-size: 1rem;
    }
    #settingsContent button:hover {
      background: #4a8cd8;
    }
    #settingsContent a {
      color: #90caf9;
      text-decoration: none;
      user-select: text;
    }
    #settingsContent a:hover {
      text-decoration: underline;
    }
    /* Cookie Consent Banner */
    #cookieConsent {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #1f1f1f;
      border: 1px solid #64b5f6;
      padding: 15px 25px;
      border-radius: 20px;
      color: #e0e0e0;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 0 15px rgba(100,181,246,0.6);
      z-index: 100;
      max-width: 500px;
      font-size: 0.95rem;
      user-select: none;
    }
    #cookieConsent button {
      background: #64b5f6;
      border: none;
      color: #121212;
      font-weight: 700;
      padding: 8px 16px;
      border-radius: 9999px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
      font-size: 0.9rem;
    }
    #cookieConsent button:hover {
      background: #4a8cd8;
    }
    /* Responsive */
    @media (max-width: 720px) {
      #sidebar {
        width: 60px !important;
        min-width: 60px !important;
      }
      #sidebar header h1 {
        display: none;
      }
      #sidebarButtons button {
        font-size: 0;
        padding: 8px;
      }
      #inputArea input[type="text"] {
        font-size: 0.9rem;
      }
      #inputArea button {
        font-size: 0.9rem;
        padding: 10px 18px;
      }
    }
  </style>
</head>
<body>
  <aside id="sidebar" aria-label="Chat List Sidebar">
    <header>
      <h1 title="FreeSearch">FreeSearch</h1>
      <button id="toggleSidebarBtn" aria-label="Toggle Sidebar">&#9776;</button>
    </header>

    <div id="chatList" role="list" aria-label="Previous Chats">
      <!-- Chats will be inserted here -->
    </div>

    <div id="sidebarButtons">
      <button id="newChatBtn" aria-label="Start New Chat">New Chat</button>
      <button id="refreshChatsBtn" aria-label="Refresh Chats">Refresh</button>
      <button id="openSettingsBtn" aria-label="Open Settings">&#9881;</button>
    </div>
  </aside>

  <section id="chatArea" role="main" aria-live="polite" aria-atomic="false">
    <div id="chatMessages" tabindex="0" aria-label="Chat Messages">
      <!-- Messages will appear here -->
    </div>

    <form id="inputArea" aria-label="Chat input form">
      <input
        type="text"
        id="input"
        placeholder="Ask a question..."
        autocomplete="off"
        aria-required="true"
        aria-label="Type your question here"
        spellcheck="false"
        />
      <button type="submit" id="askBtn" aria-label="Send Question">Ask</button>
    </form>
  </section>

  <!-- Settings Modal -->
  <div id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div id="settingsContent">
      <h2 id="settingsTitle">Settings</h2>

      <label><input type="checkbox" id="darkModeToggle" /> Enable Dark Mode</label>
      <label><input type="checkbox" id="saveChatsToggle" checked /> Save Chats in Cookies</label>

      <button id="clearCookiesBtn">Clear All Cookies</button>

      <p style="margin-top:20px; font-size: 0.9rem;">
        Inquiry or feedback? 
        <a href="https://docs.google.com/forms/d/e/1FAIpQLSf6gXYK8uN-xWUiM3_BshtLcAzEKLEwDaersX0Y5Mx2QXbWgg/viewform?usp=header" target="_blank" rel="noopener noreferrer">
          Submit here
        </a>.
      </p>

      <button id="closeSettingsBtn" style="margin-top:10px;">Close</button>
    </div>
  </div>

  <!-- Cookie Consent Banner -->
  <div id="cookieConsent" role="alertdialog" aria-live="polite" aria-atomic="true" aria-describedby="cookieConsentText" hidden>
    <span id="cookieConsentText">
      This site uses cookies to save your settings and chat history. Do you accept cookies?
    </span>
    <button id="acceptCookiesBtn">Accept</button>
  </div>

<script>
  // --- UTILITIES ---
  const cookieUtil = {
    set: (name, value, days=365) => {
      const d = new Date();
      d.setTime(d.getTime() + (days*24*60*60*1000));
      const expires = "expires="+ d.toUTCString();
      document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/";
    },
    get: (name) => {
      const cname = name + "=";
      const decodedCookie = decodeURIComponent(document.cookie);
      const ca = decodedCookie.split(';');
      for(let c of ca) {
        while(c.charAt(0) === ' ') c = c.substring(1);
        if(c.indexOf(cname) === 0) return c.substring(cname.length, c.length);
      }
      return null;
    },
    erase: (name) => {
      document.cookie = name+'=; Max-Age=-99999999;';
    }
  };

  // --- APP STATE ---
  let chats = [];
  let activeChatId = null;
  let cookieConsentGiven = false;

  // DOM Elements
  const sidebar = document.getElementById('sidebar');
  const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
  const chatListEl = document.getElementById('chatList');
  const newChatBtn = document.getElementById('newChatBtn');
  const refreshChatsBtn = document.getElementById('refreshChatsBtn');
  const openSettingsBtn = document.getElementById('openSettingsBtn');
  const chatMessagesEl = document.getElementById('chatMessages');
  const inputForm = document.getElementById('inputArea');
  const inputField = document.getElementById('input');
  const askBtn = document.getElementById('askBtn');

  // Settings Modal Elements
  const settingsModal = document.getElementById('settingsModal');
  const closeSettingsBtn = document.getElementById('closeSettingsBtn');
  const darkModeToggle = document.getElementById('darkModeToggle');
  const saveChatsToggle = document.getElementById('saveChatsToggle');
  const clearCookiesBtn = document.getElementById('clearCookiesBtn');

  // Cookie Consent Banner Elements
  const cookieConsentBanner = document.getElementById('cookieConsent');
  const acceptCookiesBtn = document.getElementById('acceptCookiesBtn');

  // --- HELPERS ---
  // Sanitize text to prevent XSS
  function sanitize(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // Generate new chat id
  function genChatId() {
    return 'chat-' + Math.random().toString(36).substring(2, 10);
  }

  // Extract "general idea" from first user message or fallback
  function generateChatTitle(messages) {
    if (!messages || messages.length === 0) return "New Chat";
    for (let msg of messages) {
      if (msg.role === 'user' && msg.content.trim().length > 0) {
        return msg.content.trim().slice(0, 30) + (msg.content.length > 30 ? '...' : '');
      }
    }
    return "New Chat";
  }

  // Save chats & settings to cookies
  function saveAllToCookies() {
    if (!cookieConsentGiven) return; // Respect consent
    if (saveChatsToggle.checked) {
      cookieUtil.set('freesearch_chats', JSON.stringify(chats));
      cookieUtil.set('freesearch_activeChatId', activeChatId);
    }
    cookieUtil.set('freesearch_darkMode', darkModeToggle.checked ? '1' : '0');
    cookieUtil.set('freesearch_saveChats', saveChatsToggle.checked ? '1' : '0');
  }

  // Load chats & settings from cookies
  function loadFromCookies() {
    // Cookie consent first
    const consent = cookieUtil.get('freesearch_cookieConsent');
    if (consent === 'accepted') {
      cookieConsentGiven = true;
      cookieConsentBanner.hidden = true;
    } else {
      cookieConsentBanner.hidden = false;
      cookieConsentGiven = false;
      return;
    }

    // Load settings
    darkModeToggle.checked = cookieUtil.get('freesearch_darkMode') === '1';
    saveChatsToggle.checked = cookieUtil.get('freesearch_saveChats') !== '0';

    // Load chats if allowed
    if (saveChatsToggle.checked) {
      const chatsJson = cookieUtil.get('freesearch_chats');
      const activeId = cookieUtil.get('freesearch_activeChatId');
      try {
        chats = chatsJson ? JSON.parse(chatsJson) : [];
        activeChatId = activeId || (chats[0] ? chats[0].id : null);
      } catch {
        chats = [];
        activeChatId = null;
      }
    }
  }

  // Render sidebar chat list
  function renderChatList() {
    chatListEl.innerHTML = '';
    for (let chat of chats) {
      const item = document.createElement('div');
      item.className = 'chatItem' + (chat.id === activeChatId ? ' active' : '');
      item.setAttribute('role', 'listitem');
      item.title = chat.title || "Chat";

      const titleSpan = document.createElement('span');
      titleSpan.className = 'chatTitle';
      titleSpan.textContent = chat.title || "Chat";

      const menuBtn = document.createElement('button');
      menuBtn.className = 'chatMenuBtn';
      menuBtn.setAttribute('aria-label', `Chat menu for ${chat.title}`);
      menuBtn.textContent = '⋮';

      const menu = document.createElement('div');
      menu.className = 'chatMenu';
      menu.setAttribute('role', 'menu');

      // Rename button
      const renameBtn = document.createElement('button');
      renameBtn.textContent = 'Rename';
      renameBtn.setAttribute('role', 'menuitem');
      renameBtn.addEventListener('click', () => {
        const newName = prompt('Enter new chat name:', chat.title);
        if (newName && newName.trim().length > 0) {
          chat.title = newName.trim();
          saveAllToCookies();
          renderChatList();
        }
        menu.classList.remove('show');
      });

      // Delete button
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Delete';
      deleteBtn.setAttribute('role', 'menuitem');
      deleteBtn.addEventListener('click', () => {
        if (confirm(`Delete chat "${chat.title}"? This cannot be undone.`)) {
          chats = chats.filter(c => c.id !== chat.id);
          if (activeChatId === chat.id) {
            activeChatId = chats.length > 0 ? chats[0].id : null;
          }
          saveAllToCookies();
          renderChatList();
          renderChatMessages();
        }
        menu.classList.remove('show');
      });

      menu.appendChild(renameBtn);
      menu.appendChild(deleteBtn);

      menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        closeAllMenus();
        menu.classList.toggle('show');
      });

      item.appendChild(titleSpan);
      item.appendChild(menuBtn);
      item.appendChild(menu);

      item.addEventListener('click', () => {
        if (activeChatId !== chat.id) {
          activeChatId = chat.id;
          saveAllToCookies();
          renderChatList();
          renderChatMessages();
        }
        closeAllMenus();
      });

      chatListEl.appendChild(item);
    }
  }

  // Close all open menus
  function closeAllMenus() {
    const menus = document.querySelectorAll('.chatMenu.show');
    menus.forEach(menu => menu.classList.remove('show'));
  }
  document.addEventListener('click', closeAllMenus);

  // Render chat messages area
  function renderChatMessages() {
    chatMessagesEl.innerHTML = '';
    if (!activeChatId) {
      chatMessagesEl.innerHTML = '<p style="color:#777; text-align:center; margin-top: 30px;">No chat selected. Start a new chat.</p>';
      return;
    }
    const chat = chats.find(c => c.id === activeChatId);
    if (!chat) return;

    for (let msg of chat.messages) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'msg ' + (msg.role === 'user' ? 'user' : 'bot');
      msgDiv.innerHTML = sanitize(msg.content);
      chatMessagesEl.appendChild(msgDiv);
    }
    // Scroll to bottom
    chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
  }

  // Add a new chat and activate it
  function newChat() {
    const chat = {
      id: genChatId(),
      title: 'New Chat',
      messages: []
    };
    chats.unshift(chat);
    activeChatId = chat.id;
    saveAllToCookies();
    renderChatList();
    renderChatMessages();
  }

  // Refresh chats list (reload from cookies)
  function refreshChats() {
    loadFromCookies();
    if (!activeChatId && chats.length > 0) {
      activeChatId = chats[0].id;
    }
    renderChatList();
    renderChatMessages();
  }

  // Add message to active chat
  function addMessage(role, content) {
    if (!activeChatId) return;
    const chat = chats.find(c => c.id === activeChatId);
    if (!chat) return;
    chat.messages.push({ role, content });
    if (!chat.title || chat.title === 'New Chat') {
      chat.title = generateChatTitle(chat.messages);
    }
    saveAllToCookies();
  }

  // Ask AI (DuckDuckGo + GPT fallback)
  async function askAI(question) {
    // Simple duckduckgo instant answer API usage
    // If no answer, fallback to GPT-3 via free open API simulation (simulate with canned response)
    try {
      const url = `https://api.duckduckgo.com/?q=${encodeURIComponent(question)}&format=json&no_redirect=1&no_html=1&skip_disambig=1`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("DuckDuckGo API error");
      const data = await res.json();

      let answer = '';
      if (data.AbstractText && data.AbstractText.trim().length > 10) {
        answer = data.AbstractText;
      } else if (data.RelatedTopics && data.RelatedTopics.length > 0) {
        // Use first related topic text
        answer = data.RelatedTopics[0].Text || '';
      }

      if (answer.trim().length < 10) {
        // Fallback GPT simulation (placeholder)
        answer = await simulateGPTResponse(question);
      }
      return answer.trim() || "Sorry, I couldn't find an answer.";
    } catch (e) {
      return await simulateGPTResponse(question);
    }
  }

  // Simulate GPT response (placeholder, since no real GPT API)
  async function simulateGPTResponse(question) {
    return new Promise(resolve => {
      setTimeout(() => {
        resolve(`I'm sorry, leader, but I do not have a precise answer for "${question}". Please refine your query or try again later.`);
      }, 1000);
    });
  }

  // Handle input form submit
  async function onAsk(e) {
    e.preventDefault();
    const question = inputField.value.trim();
    if (!question) return;
    inputField.value = '';
    inputField.disabled = true;
    askBtn.disabled = true;

    // Add user message
    addMessage('user', question);
    renderChatMessages();

    // Add bot placeholder message
    addMessage('bot', '...');
    renderChatMessages();

    // Fetch answer
    const chat = chats.find(c => c.id === activeChatId);
    if (!chat) return;

    const botMsgIndex = chat.messages.length - 1;
    const answer = await askAI(question);

    chat.messages[botMsgIndex].content = answer;
    saveAllToCookies();
    renderChatMessages();

    inputField.disabled = false;
    askBtn.disabled = false;
    inputField.focus();
  }

  // Toggle dark mode
  function toggleDarkMode(enabled) {
    if (enabled) {
      document.body.style.backgroundColor = '#121212';
      document.body.style.color = '#e0e0e0';
    } else {
      document.body.style.backgroundColor = '#fefefe';
      document.body.style.color = '#121212';
    }
  }

  // Clear all cookies with confirmation
  function clearCookies() {
    if (!confirm("Are you sure you want to clear all saved cookies? This will erase all saved chats and settings.")) return;
    const allCookies = document.cookie.split("; ");
    for (const cookie of allCookies) {
      const eqPos = cookie.indexOf("=");
      const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
      cookieUtil.erase(name);
    }
    chats = [];
    activeChatId = null;
    saveAllToCookies();
    renderChatList();
    renderChatMessages();
    alert("Cookies cleared.");
  }

  // Accept cookies consent
  function acceptCookies() {
    cookieConsentGiven = true;
    cookieUtil.set('freesearch_cookieConsent', 'accepted');
    cookieConsentBanner.hidden = true;
    saveAllToCookies();
  }

  // Toggle sidebar collapsed state
  function toggleSidebar() {
    sidebar.classList.toggle('collapsed');
  }

  // --- EVENTS ---
  inputForm.addEventListener('submit', onAsk);
  newChatBtn.addEventListener('click', () => {
    newChat();
  });
  refreshChatsBtn.addEventListener('click', () => {
    refreshChats();
  });
  openSettingsBtn.addEventListener('click', () => {
    settingsModal.classList.add('show');
  });
  closeSettingsBtn.addEventListener('click', () => {
    settingsModal.classList.remove('show');
  });
  darkModeToggle.addEventListener('change', () => {
    toggleDarkMode(darkModeToggle.checked);
    saveAllToCookies();
  });
  saveChatsToggle.addEventListener('change', () => {
    saveAllToCookies();
  });
  clearCookiesBtn.addEventListener('click', clearCookies);
  acceptCookiesBtn.addEventListener('click', acceptCookies);
  toggleSidebarBtn.addEventListener('click', toggleSidebar);

  // Keyboard accessibility: close settings on ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (settingsModal.classList.contains('show')) {
        settingsModal.classList.remove('show');
      }
      closeAllMenus();
    }
  });

  // --- INIT ---
  (function init() {
    loadFromCookies();
    toggleDarkMode(darkModeToggle.checked);
    if (chats.length === 0) {
      newChat();
    } else {
      if (!activeChatId && chats.length > 0) activeChatId = chats[0].id;
      renderChatList();
      renderChatMessages();
    }
  })();
</script>
</body>
</html>
